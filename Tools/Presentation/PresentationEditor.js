var _form,presentationEditor=null,SGWorld=null;function init(){SGWorld=initSGWorld(),presentationEditor=new PresentationEditor,_form=new Form("_fieldset"),$("#menuPlayFroHere").text(SGLang.i18n("playFromHere")),$("#menuJumpHere").text(SGLang.i18n("JumpHere")),$("#menuCopyAction").text(SGLang.i18n("copyAction")),$("#menuPasteAction").text(SGLang.i18n("pasteAction")),$("#menuEditAction").text(SGLang.i18n("edit")),$("#menuDeleteAction").text(SGLang.i18n("delete")),$("#menuDeleteMulti").text(SGLang.i18n("deleteMulti")),$("#menuCopyStep").text(SGLang.i18n("copyStep")),$("#menuPasteStep").text(SGLang.i18n("pasteStep")),$("#menuRenameStep").text(SGLang.i18n("rename")),$("#menuToggleWaitStep").text(SGLang.i18n("removeWaitForClick")),$("#menuDeleteStep").text(SGLang.i18n("delete")),$("#toolboxDiv").css("display","none"),$("img").on("dragstart",function(event){event.preventDefault()});var selected=SGWorld.ProjectTree.GetNextItem("",ItemCode.SELECTED);selected&&(SGWorld.Creator.GetObject(selected).ObjectType==ObjectTypeCode.OT_PRESENTATION?(presentationEditor.presentationId=selected,presentationEditor.updateTreeFromTe(),selected=presentationEditor.getPresentation().CurrentlyPlayingItemId,presentationEditor.selectItem(selected)):presentationEditor.presentationId=""),$(window).click(function(){"visible"==$(".toolbox-dropdown-content").css("visibility")&&($(".toolbox-dropdown-content").css("visibility","hidden"),event.stopPropagation()),presentationEditor.closeItemPopup()}),document.getElementById("stepsList").firstChild&&presentationEditor.scrollToId(document.getElementById("stepsList").firstChild.id)}function uninit(){presentationEditor.onEditorClosing()}function escapeRegExp(string){return string.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function replaceAll(str,find,replace){return str.replace(new RegExp(escapeRegExp(find),"g"),replace)}function log(text){}function addEvent(obj,evt,fn){obj.addEventListener?obj.addEventListener(evt,fn,!1):obj.attachEvent&&obj.attachEvent("on"+evt,fn)}function PresentationEditor(){var self=new Object;return self.presentationId="",self.actionsList=[],self.largeActionListView=!1,self.hideFirstStepClickAction=!0,self.isRecording=!1,self.itemIdBuffer="",self.movieSettings={frameSize:0,framesPerSec:25,hideOverlay:!1},self.getPresentation=function(id){try{var teObj=SGWorld.Creator.GetObject(null!=id?id:self.presentationId);return teObj.ObjectType==ObjectTypeCode.OT_PRESENTATION?teObj:null}catch(e){return null}},self.getTeContainer=function(){for(var toolName=SGLang.i18n("ToolName"),i=0;i<SGWorld.Application.Containers.Count;i++){var container=SGWorld.Application.Containers.Item(i);if(0<=container.Name.indexOf(toolName))return container}},self.onEditorClosing=function(){self.getPresentation()&&self.getPresentation().ShowPath(0,!0,!1)},self.clearList=function(){for(var actionList=document.getElementById("stepsList");actionList.firstChild;)actionList.removeChild(actionList.lastChild);_form.clearForm(),_form.close()},self.actionTypeToImage=function(action){var type=action.actionType;return type==PresentationAction.Click?"images/listClick.svg":type==PresentationAction.FlyTo?"images/listLocation.svg":type==PresentationAction.JumpTo?"images/listLocationJump.svg":type==PresentationAction.Show?"images/listShow.svg":type==PresentationAction.Hide?"images/listHide.svg":type==PresentationAction.Wait?"images/listWait.svg":type==PresentationAction.Caption?-2==action.options.timeOutInterval?"images/listClearCaption.svg":"images/listCaption.svg":type==PresentationAction.Message?"images/listMessage.svg":type==PresentationAction.DynamicObject?"images/listRestartDynamic.svg":type==PresentationAction.UndergroundMode?"images/listUnderground.svg":type==PresentationAction.SetTime?"images/listSetTime.svg":type==PresentationAction.PlayAnotherPresentation?"images/listAnotherPresentation.svg":type==PresentationAction.PlayRoute?"images/listPlayRoute.svg":type==PresentationAction.SetSpeedFactor?"images/listSpeedFactor.svg":" "},self.getActionById=function(actionId){var theAction,steps=self.presentation.steps;if(0!=steps.length)return steps.filter(function(step){step=step.actions;return 0!=step.length&&(null!=theAction&&0<theAction.length||null!=(theAction=step.filter(function(action){return action.id==actionId}))&&0<theAction.length)}),theAction?theAction[0]:void 0},self.openPropertiesPanel=function(offsetTop){1<$(".selected_").length?_form.close():($("#properties").css("height",_form.propertiesPageHeight<0?"100%":"300px"),$("#properties").show(),_form.currentData&&self.scrollToId(_form.currentData.id))},self.closePropertiesPanel=function(){self.showingSettings=!1,$("#btnStep").removeClass("toolboxIconDisabled"),$("#btnTbNewAction").removeClass("toolboxIconDisabled"),$("#properties").hide(),$("#presentationItems").show()},self.isDoubleClick=!1,self.onActionDoubleClicked=function(actionId){self.isDoubleClick=!0,self.isEditMode()||null!=self.getActionById(actionId)&&self.getPresentation().PlayFromID(actionId)},self.cleanStepDivId=function(id){return 0<=id.indexOf("step_div_")?id=id.slice(9):0<id.indexOf("_div")&&(id=id.slice(0,-4)),id},self.getSelectedEntriesIds=function(){var selectedEntriesIds=[];try{$(".selected_").each(function(index){var id=self.cleanStepDivId(this.id);""!=id&&(self.getPresentation().GetItem(id),selectedEntriesIds.push(id))})}catch(e){}return selectedEntriesIds},self.getSelectedEntry=function(){try{var selected=$(".selected_");if(1==selected.length){var element=selected[0];if(""!=element.id){var id="";if(0<=element.id.indexOf("step_div_")?id=element.id.slice(9):0<element.id.indexOf("_div")&&(id=element.id.slice(0,-4)),""!=id)return self.getPresentation().GetItem(id)}}else if(0==selected.length)return}catch(e){}},self.getSelectedEntryId=function(){var currentSelected=self.getSelectedEntry();if(currentSelected)return currentSelected.ID},self.onStepClicked=function(stepId,onClicked){if(null!=stepId){if(self.showSelected("step_div_"+stepId),self.getSelectedEntry()&&self.getPresentation().ShowPath(0,!0,!1),self.isEditMode()){self.getPresentation().ShowPath(stepId,!0,!0);stepId=self.getPresentation().GetItem(stepId);if(null==stepId)return;var actionSchema=presentationSchema;1==_form.setProperties(stepId,actionSchema)?(self.openPropertiesPanel(),_form.onClose=self.closePropertiesPanel):self.closePropertiesPanel()}onClicked&&onClicked()}},self.onStepDoubleClicked=function(stepId){self.isDoubleClick=!0,self.isEditMode()||self.getPresentation().PlayFromID(stepId)},self.closeItemPopup=function(id){$("#actionMenu").offset({top:-400,left:-400})},self.doContextOperation=function(func){func($("#actionMenu").attr("targetId"))},self.openShowActionPopup=function(item,e){var isStep=0==item.Type,playing=!self.isEditMode(),isMultiSelection=1<$(".selected_").length,isMultiSelection=($("#menuPlayFroHere").css("display",isMultiSelection?"none":"block"),$("#menuJumpHere").css("display",playing||isMultiSelection?"none":"block"),$("#menuCopyAction").css("display",playing||isStep||isMultiSelection?"none":"block"),$("#menuPasteAction").css("display",playing||isStep||isMultiSelection?"none":"block"),$("#menuEditAction").css("display","none"),$("#menuDeleteAction").css("display",playing||isStep||isMultiSelection?"none":"block"),$("#menuDeleteMulti").css("display",playing||isStep||!isMultiSelection?"none":"block"),$("#menuCopyStep").css("display",playing||isMultiSelection||!isStep?"none":"block"),$("#menuPasteStep").css("display",playing||!isStep||isMultiSelection?"none":"block"),$("#menuRenameStep").css("display","none"),!0),actionData=(isStep&&item.FirstChild&&(actionData=self.getActionById(item.FirstChild.ID))&&(actionData.actionType,isMultiSelection=1==SGWorld.SetParamEx(9954,actionData.id,999)),$("#menuToggleWaitStep").text(SGLang.i18n(isMultiSelection?"removeWaitForClick":"addWaitForClick")),$("#menuToggleWaitStep").css("display","none"),$("#menuDeleteStep").css("display",playing||!isStep?"none":"block"),e.clientX+6+$("#actionMenu").width()>$("#Body").width()?e.clientX-6-$("#actionMenu").width():e.clientX+6),isMultiSelection=e.clientY+6+$("#actionMenu").height()>$("#Body").height()?e.clientY-6-$("#actionMenu").height():e.clientY+6;$("#actionMenu").attr("targetId",item.id).offset({top:isMultiSelection,left:actionData}),$("#actionMenu").show()},self.onCopyItem=function(id){self.itemIdBuffer=id,self.closeItemPopup(id)},self.canPasteOnItem=function(targetId){var dropItem;return""!=self.itemIdBuffer&&(dropItem=self.getPresentation().GetItem(self.itemIdBuffer),targetId=self.getPresentation().GetItem(targetId),!(!dropItem||!targetId))&&dropItem.Type==targetId.Type},self.onPasteItem=function(id){var pasteBeforId,pasteTarget;self.canPasteOnItem(id)&&(pasteBeforId=(pasteTarget=self.getPresentation().GetItem(id)).NextSibling?pasteTarget.NextSibling.ID:"",pasteTarget=pasteTarget.Parent.ID,self.getPresentation().CopyItem(self.itemIdBuffer,pasteTarget,pasteBeforId),self.updateTreeFromTe()),self.closeItemPopup(id)},self.onPlayItem=function(id){self.getPresentation().PlayFromID(id),self.closeItemPopup(id)},self.onJumpToItem=function(id){try{var pos=self.getPresentation().GetItemPosition(id);SGWorld.Navigate.SetPosition(pos)}catch(e){}self.closeItemPopup(id)},self.onEditItem=function(actionId){self.onActionClicked(actionId),self.closeItemPopup(actionId)},self.onDeleteMultiItem=function(){var text=SGLang.i18n("multiDeletionConfirmation");if(1==confirm(text)){try{$(".selected_").each(function(index){self.getPresentation().DeleteItem(this.id)})}catch(e){}self.updateTreeFromTe()}},self.onDeleteStep=function(stepId){var step,text;$(self.presentation.steps).each(function(index,_step){_step.id==stepId&&(step=_step)}),null!=step&&(text=SGLang.i18n("actionDeletionConfirmation")+'\n"'+step.description+'"?',1==confirm(text)&&(self.getPresentation().DeleteItem(stepId),self.updateTreeFromTe()),self.closeItemPopup(stepId))},self.onDeleteItem=function(actionId){null==actionId&&(actionId=_form.currentData.id);var actionData=self.getActionById(actionId);null!=actionData&&(actionData=(actionData=_form.getDescriptionFor(actionData))[0]+actionData[1],actionData=SGLang.i18n("actionDeletionConfirmation")+'\n"'+actionData+'"?',1==confirm(actionData)&&(self.getPresentation().DeleteItem(actionId),self.updateTreeFromTe()),self.closeItemPopup(actionId))},self.onActionClicked=function(actionId,onClicked){var actionSchema,actionData=self.getActionById(actionId);null!=actionData&&0!=self.selectItem(actionData.id)&&(actionSchema=presentationSchema,"Stopped"==self.getPresentation().Status&&(1==_form.setProperties(actionData,actionSchema)?(self.openPropertiesPanel(),_form.onClose=self.closePropertiesPanel,self.getPresentation().ShowPath(0,!0,!1),self.getPresentation().ShowPath(actionId,!0,!0)):self.closePropertiesPanel()),onClicked)&&onClicked()},self._hoverHelperTimerId,self.createActionsEntries=function(actions){var ul=document.createElement("ul");for(let i=0;i<actions.length;i++){var entryName=_form.getDescriptionFor(actions[i]),vis="visible";self.hideFirstStepClickAction&&0==i&&"Click"==actions[i].actionType&&(vis="hidden; height:0px"),$(ul).append("<li class='liEntry' id='"+actions[i].id+"' order='"+i+"' style='border-top: 2px solid white; border-radius: 6px; visibility: "+vis+";'                                         ondrop = 'presentationEditor.dragDrop.onDropAction(event)'                                        ondragstart = 'presentationEditor.dragDrop.onActionDragStart(event)'                                        ondragover = 'presentationEditor.dragDrop.onDragOverAction(event)'                                        ondragleave = 'presentationEditor.dragDrop.onDragLeaveAction(event)'                                        ondragenter = 'presentationEditor.dragDrop.onDragEnterAction(event)'                                        oncontextmenu = 'presentationEditor.onContext(event,\""+actions[i].id+"\")'>                                    <div id='"+actions[i].id+"_drop_target' style='position:absolute; width:100%; height: 2px; background-color: #00d8ff; top: -2px; display:none;'><span style='position:absolute; top: -15px; left: -12px; color:#00d8ff; font-size: 42px;'>&#x00b0;</span></div>                                    <div class='liContainer' onmouseover='presentationEditor.onMouseActionHover(\""+actions[i].id+"\")' onmouseout='presentationEditor.onMouseActionOut(\""+actions[i].id+"\")'>                                        <div id='"+actions[i].id+"_div' style='text-align: left; width:100%;'                                                    onclick='presentationEditor.onActionClicked(\""+actions[i].id+"\")'                                                    ondblclick='presentationEditor.onActionDoubleClicked(\""+actions[i].id+"\");'>                                            <div draggable='true' style='background-color: rgba(255,0,0,0.0); '>                                                <img style='vertical-align:middle; margin-left:5px; object-fit: contain; width: 16px; height: 16px;' src='"+self.actionTypeToImage(actions[i])+"' alt=''>                                                <span class='no_selection' id='"+actions[i].id+"_span' style='vertical-align:middle;  padding: 0px 4px 0px 4px; width: calc(100%-70px);'                                                    <b>"+entryName[0]+"</b>"+entryName[1]+"                                                </span>                                            </div>                                        </div>                                    </div>                            </li>")}return ul},self.onContext=function(e,id){var idHasSelection=self.hasSelection(id),item=self.getPresentation().GetItem(id);""!=item&&null!=item&&(self.openShowActionPopup(item,e),0==(0==item.Type)&&0==idHasSelection&&(self.clearSelection(),self.showSelected(id)),e.preventDefault())},self.onMouseActionHover=function(id){$("#"+id).find("#menu_").css("visibility",self.isEditMode()?"visible":"hidden")},self.onMouseActionOut=function(id){$("#"+id).find("#menu_").css("visibility","hidden")},self.updateActionEntryDescription=function(actionId){var actionData=self.getActionById(actionId);null!=actionData&&(actionData=_form.getDescriptionFor(actionData),$("#"+actionId+"_span").html("<b>"+actionData[0]+"</b>"+actionData[1]),actionId=replaceAll(actionId=actionData[0]," ",""),actionData[1].slice(1,-1),$("#input_"+actionId).attr("value",actionData[1].slice(1,-1)))},self.onOpenCloseStep=function(stepId){var li;0<$("#"+stepId+" li").length?($("#stepActions__"+stepId).remove(),$("#imgOpenClose_"+stepId).attr("src","images/listPlus.png")):(li=$("#"+stepId)[0],self.createStepDiv(li,stepId),$("#imgOpenClose_"+stepId).attr("src","images/listMinus.png"))},self.createStepDiv=function(li,stepId){$(self.presentation.steps).each(function(index,_step){_step.id==stepId&&(step=_step)});var step,ul,div=document.createElement("div");null==step?div.textContent="Error":(div.id="stepActions__"+step.id,ul=self.createActionsEntries(step.actions),div.appendChild(ul)),li.appendChild(div)},self.createStepsList=function(steps){self.clearList();var stepsOl=document.getElementById("stepsList");for(let i=0;i<steps.length;i++){var li=document.createElement("li"),stepColor="#000000";try{steps[i].anotherPresentationStep&&(stepColor="#04859C"),"PlayAnotherPresentation"!=steps[i].actions[0].actionType&&"PlayAnotherPresentation"!=steps[i].actions[1].actionType||(stepColor="#04859C")}catch(e){}$(li).addClass("liEntry"),$(li).append("<div style='text-align: left;  width:100%;'                                ondrop = 'presentationEditor.dragDrop.onDropStep(event)'                               ondragstart = 'presentationEditor.dragDrop.onStepDragStart(event)'                               ondragend = 'presentationEditor.dragDrop.onStepDragEnd(event)'                               ondragover = 'presentationEditor.dragDrop.onDragOverStep(event)'                               ondragleave = 'presentationEditor.dragDrop.onDragLeaveStep(event)'                               ondragenter = 'presentationEditor.dragDrop.onDragEnterStep(event)'                               oncontextmenu = 'presentationEditor.onContext(event,\""+steps[i].id+"\")'                               onclick = 'presentationEditor.onStepClicked(\""+steps[i].id+"\")' >                            <div id='"+steps[i].id+"_drop_target' style='position:absolute; width:1000px; height: 2px; background-color: #00d8ff; left: 8px; top: -2px; display:none;'><span style='position:absolute; top: -20px; left: -14px; color:#00d8ff; font-size: 32px;'>&#x25cf;</span></div>                                <div id='step_div_"+steps[i].id+"' style='display: flex; flex-wrap: nowrap; width:100%; border-radius: 6px;'>                                    <img id='imgOpenClose_"+steps[i].id+"' style='vertical-align:middle; position: absolute; left: -6px; top: 1px;' src='images/listMinus.png' alt='' onclick='presentationEditor.onOpenCloseStep(\""+steps[i].id+"\")'>                                    <span id='step_"+steps[i].id+"' draggable='true' style='color: "+stepColor+"; vertical-align:middle; width:100%; padding:4px; margin: -2px -4px 0px 1px;'ondblclick='presentationEditor.onStepDoubleClicked(\""+steps[i].id+"\")'>"+steps[i].description+"<span style='color: #c0c0c0;'></span></span>                                </div>                            </div>"),li.id=steps[i].id,li.order=i,self.createStepDiv(li,steps[i].id),stepsOl.appendChild(li),self.addAnotherPresentationHeader(li,steps[i].id)}},self.addAnotherPresentationHeader=function(li,stepId){var otherPresentationName,otherPresentation;0==self.getPresentation().GetItem(self.presentation.id).IsParentOf(stepId)&&(otherPresentationName=(otherPresentation=self.getPresentation().GetItem(stepId).Parent).Description,(otherPresentation=SGWorld.Creator.GetObject(otherPresentation.ID))&&(otherPresentationName=otherPresentation.TreeItem.Name),tc=$("#step_"+stepId)[0].textContent,tc+=" <span class='s9' style='color:#a0a0a0; opacity:0.7; margin-left:10px;'>["+otherPresentationName+" ]</span>",$("#step_"+stepId)[0].innerHTML=tc)},self.isEditMode=function(){return"Stopped"==self.getPresentation().Status},self.updateTreeFromTe=function(playingPresentation){try{var tePresentationJson;playingPresentation?self.presentation=playingPresentation:(tePresentationJson=self.getPresentation().PresentationJSON,self.presentation=JSON.parse(tePresentationJson).presentation),self.createStepsList(self.presentation.steps),$("#caption1").html(self.presentation.description),$("#toolboxDiv").css("display",self.isEditMode()?"flex":"none")}catch(e){console.log(e.message)}},self.toggleRecord=function(){self.isRecording?self.stopRecord():self.startRecord()},self.startRecord=function(){self.isRecording?self.stopRecord():(self.isRecording=!0,self._posLastFrame=SGWorld.Navigate.GetPosition(AltitudeTypeCode.ATC_TERRAIN_ABSOLUTE),self._arrRoutePoints=[],$("#btnRecord2")[0].src="./images/stopRecordCircle.png",$("#btnRecordText2")[0].textContent="Stop recording",$("#btnRecord2").addClass("recordPulsing"),SGWorld.AttachEvent("OnFrame",self._record))},self.cancelRecord=function(){$("#btnRecord2")[0].src="./images/record.png",$("#btnRecordText2")[0].textContent="Start recording",$("#btnRecord2").removeClass("recordPulsing"),self.isRecording=!1,self._posLastFrame=null,self._arrRoutePoints=[],$("#btnStep").css("display","block"),$("#btnCreateMovie").css("display","block"),$("#sep").css("display","block"),$("#tbnh").css("display","block"),$("#sep2").css("display","block"),$("#btnSettings").css("display","block"),$("#startStopRecord").css("display","none"),$("#cancelRecord").css("display","none")},self.stopRecord=function(){var routeActionJson,routeAction;self.isRecording&&(routeActionJson=JSON.stringify({actionType:"PlayRoute",options:{waypoints:self._arrRoutePoints}}),routeAction=self.getPresentation().CreateAction(routeActionJson),self._updateTreeAndOpenPropertyForId(routeAction.ID,function(){_form.setCurrentViewerLocationAsActionLocation(routeAction.ID)}),self.cancelRecord())},self._recordTime=0,self._recordInterval=.2,self._posLastFrame=null,self._arrRoutePoints=[],self._record=function(){var pos,distance,flightVector;self.isRecording?(pos=SGWorld.Navigate.GetPosition(AltitudeTypeCode.ATC_TERRAIN_ABSOLUTE),flightVector=self._posLastFrame.AimTo(pos),distance=self._posLastFrame.DistanceTo(pos),(new Date).getTime()>self._recordTime+1e3*self._recordInterval&&(flightVector={x:pos.X,y:pos.Y,altitude:pos.Altitude,yaw:flightVector.Yaw,pitch:flightVector.Pitch,dist:distance,cameraPitch:pos.Pitch,cameraYaw:pos.Yaw,timeFromPrevWaypoint:self._recordInterval},self._arrRoutePoints.push(flightVector),self._recordTime=(new Date).getTime()),self._posLastFrame=pos):SGWorld.DetachEvent("OnFrame",self._record)},self.onProjectTreeAction=function(id,action){try{var teObj;action.Code==ActionCode.AC_SELCHANGED&&(""!=id&&(_form.lastKnownSelectedItemId=id),0!=(1&SGWorld.Window.GetMouseInfo().Flags)||""!=self.presentationId&&"Stopped"!=self.getPresentation().Status||(_form.dragPayloadId=void 0,""!=id&&(teObj=SGWorld.Creator.GetObject(id))&&teObj.ObjectType==ObjectTypeCode.OT_PRESENTATION&&(self.presentationId=id,self.updateTreeFromTe(),document.getElementById("presentationItems").top=0,document.getElementById("presentationItems").scrollTop=0)))}catch(e){log(e.message)}},self.selectItem=function(itemId){try{var action,itemToSelectId;if(itemId)return itemToSelectId=itemId,self.hideFirstStepClickAction&&(action=self.getPresentation().GetItem(itemId))&&action.Parent&&action.Parent.FirstChild.ID==itemId&&1==action.Parent.FirstChild.Type&&(action.Parent.ID,itemToSelectId=action.Parent.ID),self.showSelected(itemToSelectId);self.showSelected(void 0)}catch(e){}return!1},self.clearSelection=function(){$(".selected_").removeClass("selected_")},self.showSelected=function(id){var isMultiSelect=!1;if(0==(isMultiSelect=window.event&&(window.event.ctrlKey||window.event.shiftKey)?!0:isMultiSelect))$(".selected_").removeClass("selected_");else if(self.hasSelection(id))return $("#"+id).removeClass("selected_"),!1;isMultiSelect=isMultiSelect&&1==window.event.shiftKey;return self.addToSelection(id,isMultiSelect),self.hasSelection(id)},self.isValidForMultiSelection=function(firstSelectedId,id){try{var item,actionData,firstSelectionElementType=self.getPresentation().GetItem(firstSelectedId).Type,action=self.getActionById(firstSelectedId);return action&&"PlayAnotherPresentation"==action.actionType?!1:(item=self.getPresentation().GetItem(id),elementType=item.Type,actionData=self.getActionById(item.ID),elementAction=actionData?actionData.actionType:"",elementType==firstSelectionElementType&&"Click"!=elementAction&&"PlayAnotherPresentation"!=elementAction)}catch(e){}return!1},self.addToSelection=function(id,isShiftSelection){id=self.cleanStepDivId(id);var firstSelectedId,div_id,item=self.getPresentation().GetItem(id);item&&(0<$(".selected_").length?(firstSelectedId=self.cleanStepDivId($(".selected_")[0].id),self.isValidForMultiSelection(firstSelectedId,id)&&(div_id=0==item.Type?"#step_div_"+id:"#"+id,$(div_id).addClass("selected_"),isShiftSelection)&&self.shiftSelect(firstSelectedId)):(div_id=0==item.Type?"#step_div_"+id:"#"+id,$(div_id).addClass("selected_")))},self.shiftSelect=function(firstSelectedId){var selecting=!1,idsInSelection=self.getSelectedEntriesIds(),slectedCount=idsInSelection.length,firstSelectionElementType=self.getPresentation().GetItem(firstSelectedId).Type;try{$(".liEntry").each(function(index){var _id=self.cleanStepDivId(this.id),scannedItem=self.getPresentation().GetItem(_id);if(scannedItem.Type==firstSelectionElementType){if(0<slectedCount&&0<=idsInSelection.indexOf(_id)&&(slectedCount--,selecting=selecting||!0),0==slectedCount&&selecting)return!1;if(selecting){if(0==self.isValidForMultiSelection(firstSelectedId,_id))return!0;scannedItem=0==scannedItem.Type?"#step_div_"+_id:"#"+_id;$(scannedItem).addClass("selected_")}}})}catch(e){}},self.hasSelection=function(id){return $("#"+id).hasClass("selected_")},self.openCreateMovie=function(){self.openSettings(!0)},self.openSettings=function(createMovieSettings){var settingsIsOpen=$("#btnStep").hasClass("toolboxIconDisabled");_form.close(),settingsIsOpen||1==_form.openSettings(createMovieSettings)&&($("#btnStep").addClass("toolboxIconDisabled"),$("#btnTbNewAction").addClass("toolboxIconDisabled"),$("#properties").css("height","90%"),$("#properties").show(),$("#presentationItems").hide(),_form.onClose=self.closePropertiesPanel)},self.scrollParentToChild=function(parent,child){var parentRect,parentViewableArea_height;null==parent||null==child||(parentRect=parent.getBoundingClientRect(),parentViewableArea_height=parent.clientHeight,parent.clientWidth,(child=child.getBoundingClientRect()).top>=parentRect.top&&child.bottom<=parentRect.top+parentViewableArea_height)||(parentViewableArea_height=child.top-parentRect.top,child=child.bottom-parentRect.bottom,Math.abs(parentViewableArea_height)<Math.abs(child)?parent.scrollTop+=parentViewableArea_height:parent.scrollTop+=20+child)},self.onKeyboardEvent=function(Message,Char,KeyState){try{257==Message&&32==Char&&self.simulateUserContinueOrSkip()}catch(e){log(e.message)}},self.onPresentationEvent=function(eventParams){try{var presentation,action,selected,event=JSON.parse(eventParams);try{action=null!=(presentation=self.getPresentation(event.presentationId))&&event.itemId&&""!=event.itemId?presentation.GetItem(event.itemId):null}catch(e){log(e.message)}switch(event.eventName){case"Started":self.updateTreeFromTe(event.flatPresentation),_form.close();break;case"ActionStarting":null!=action&&(self.selectItem(action.ID),self.scrollParentToChild($("#presentationItems")[0],$("#"+action.ID)[0]));break;case"ActionFinished":case"WaitProgress":break;case"StatusChanged":"Stopped"==event.newStatus?($("#toolboxDiv").css("display","flex"),(selected=SGWorld.ProjectTree.GetNextItem("",ItemCode.SELECTED))&&SGWorld.Creator.GetObject(selected).ObjectType==ObjectTypeCode.OT_PRESENTATION&&(presentationEditor.presentationId=selected),self.selectItem(void 0),self.updateTreeFromTe()):($("#toolboxDiv").css("display","none"),self.getPresentation().ShowPath(0,!0,!1))}}catch(e){log(e.message)}return!0},self.scrollToId=function(id){self.scrollParentToChild($("#presentationItems")[0],$("#"+id)[0])},self._defaultFlyToAction=JSON.stringify({actionType:"FlyTo",options:{poi:{altitude:0,distance:0,isRelative:!1,viewerPitch:0,viewerYaw:0,x:0,y:0}}}),self._defaultMenuAction=function(_teCommandId){return JSON.stringify({actionType:"MenuCommand",options:{teCommandId:_teCommandId,checked:!0}})},self._defaultShowAction=JSON.stringify({actionType:"Show",options:{pathToGroup:" "}}),self._defaultHideAction=JSON.stringify({actionType:"Hide",options:{pathToGroup:" "}}),self._defaultWaitAction=JSON.stringify({actionType:"Wait",options:{duration:5}}),self._defaultCaptionAction=JSON.stringify({actionType:"Caption",options:{captionText:"-- new caption --",captionHeight:20,captionWidth:300,fontSize:14,position:4}}),self._defaultClearCaptionAction=JSON.stringify({actionType:"Caption",options:{timeOutInterval:-2}}),self._defaultRestartDynamicAction=JSON.stringify({actionType:"DynamicObject",options:{TeObjectId:"0_0"}}),self._defaultUndergroundAction=JSON.stringify({actionType:"UndergroundMode",options:{showUnderground:!0}}),self._defaultRemoveUndergroundAction=JSON.stringify({actionType:"UndergroundMode",options:{showUnderground:!1}}),self._defaultPlayAnotherPresentationAction=JSON.stringify({actionType:"PlayAnotherPresentation",options:{TeObjectId:"0_0"}}),self._defaultSetTimeAction=JSON.stringify({actionType:"SetTime",options:{year:0,month:0,day:0,hour:0,minute:0,second:0}}),self._dummyRecordAction=JSON.stringify({actionType:"Click",options:{dummy:"Record"}}),self._updateTreeAndOpenPropertyForId=function(id,onAfterItemClicked){self.updateTreeFromTe(),self.onActionClicked(id,function(){self.scrollToId(id),onAfterItemClicked&&onAfterItemClicked()})},self.onToggleWaitStep=function(stepId){var actionData,stepId=self.getPresentation().GetItem(stepId),hasWait=!0;(hasWait=stepId&&stepId.FirstChild?"Click"==(actionData=self.getActionById(stepId.FirstChild.ID)).actionType:hasWait)&&(stepId=1==SGWorld.SetParamEx(9954,actionData.id,999),SGWorld.SetParamEx(9954,actionData.id,stepId?0:1)),self.updateTreeFromTe()},self.onRenameStep=function(stepId,callback){var step=self.getPresentation().GetItem(stepId),originalVal=(self.onStepClicked(step.ID),$("#step_"+step.ID)[0].textContent),input=($("#step_"+step.ID)[0].textContent="",self.scrollToId(step.ID),$("<input>",{type:"text",placeholder:"new step",id:"input_step",value:originalVal}));input.css("border-color","rgba(0,216,255, 0.4)"),input.on("change keyup focusout",function(e){var stepJson;"keyup"==e.type&&"Enter"!=e.key||(0==(e=$(this).val()).length&&(e=originalVal),(stepJson=JSON.parse(step.ItemJSON)).description=e,step.ItemJSON=JSON.stringify(stepJson),$(this).remove(),self.updateTreeFromTe())}),self.closeItemPopup(stepId),$("#step_"+step.ID).append(input),input.select(),input.focus()},self.createNewStep=function(){var step;if(self.isEditMode())return self.getSelectedEntryId(),step=self.getPresentation().CreateStep("New Step"),self.updateTreeFromTe(),step.id},self.closeActionMenu=function(){$(".toolbox-dropdown-content").css("visibility","hidden")},self.actionsMenuClicked=function(){setTimeout(function(){$(".toolbox-dropdown-content").css("visibility","visible")},50)},self.repositionNewItem=function(newItem,selectedId){try{var selectedItem;selectedId&&(0==(selectedItem=self.getPresentation().GetItem(selectedId)).Type?self.getPresentation().MoveItem(newItem.ID,selectedItem.ID,""):0==newItem.Type?self.getPresentation().MoveItem(newItem.ID,newItem.Parent.ID,self.nextSibilingIdOf(selectedItem.Parent.ID)):self.getPresentation().MoveItem(newItem.ID,selectedItem.Parent.ID,self.nextSibilingIdOf(selectedItem.ID)))}catch(e){}},self.createNewAction=function(action){if(self.isEditMode())try{var currentSelectedId=self.getSelectedEntryId(),newAction=self.getPresentation().CreateAction(action);newAction.Parent.ID;self.repositionNewItem(newAction,currentSelectedId),self._updateTreeAndOpenPropertyForId(newAction.ID),self.closeActionMenu()}catch(e){}},self.createMenuAction=function(event,teCommandId){var menuAction;self.isEditMode()&&(event.stopPropagation(),self.closeActionMenu(),menuAction=self.getPresentation().CreateAction(self._defaultMenuAction(teCommandId)),self._updateTreeAndOpenPropertyForId(menuAction.ID,function(){_form.setCurrentViewerLocationAsActionLocation(menuAction.ID)}))},self.createNewFlyTo=function(event){var currentSelectedId,flyToAction;self.isEditMode()&&(currentSelectedId=self.getSelectedEntryId(),event.stopPropagation(),self.closeActionMenu(),flyToAction=self.getPresentation().CreateAction(self._defaultFlyToAction),self.repositionNewItem(flyToAction,currentSelectedId),self._updateTreeAndOpenPropertyForId(flyToAction.ID,function(){_form.setCurrentViewerLocationAsActionLocation(flyToAction.ID)}))},self.createNewRecord=function(event){self.isEditMode()&&(event.stopPropagation(),self.closeActionMenu(),$("#btnStep").css("display","none"),$("#btnCreateMovie").css("display","none"),$("#sep").css("display","none"),$("#tbnh").css("display","none"),$("#sep2").css("display","none"),$("#btnSettings").css("display","none"),$("#startStopRecord").css("display","flex"),$("#cancelRecord").css("display","flex"))},self.createNewShow=function(event){$("#btnHide").css("visibility","hidden"),self.createNewAction(self._defaultShowAction),event.stopPropagation()},self.createNewHide=function(event){$("#btnHide").css("visibility","hidden"),self.createNewAction(self._defaultHideAction),event.stopPropagation()},self.createNewWait=function(event){self.createNewAction(self._defaultWaitAction),event.stopPropagation()},self.createNewCaption=function(event){$("#btnClearCaption").css("visibility","hidden"),self.createNewAction(self._defaultCaptionAction),event.stopPropagation()},self.createNewClearCaption=function(event){$("#btnClearCaption").css("visibility","hidden"),self.createNewAction(self._defaultClearCaptionAction),event.stopPropagation()},self.createNewMessage=function(event){var dummy=SGWorld.Creator.CreateTreeHotlink("",SGWorld.ProjectTree.HiddenGroupID),teMessageId=(SGWorld.ProjectTree.EditItem(dummy.ID),dummy.Message.MessageID),dummy=(SGWorld.Creator.DeleteObject(dummy.ID),SGWorld.ProjectTree.SelectItem(presentationEditor.presentation.id),JSON.stringify({actionType:"Message",options:{TeObjectId:teMessageId}}));self.createNewAction(dummy),event.stopPropagation()},self.createNewRestartDynamic=function(event){self.createNewAction(self._defaultRestartDynamicAction),event.stopPropagation()},self.createNewUndergroundMode=function(event){self.createNewAction(self._defaultUndergroundAction),event.stopPropagation()},self.createNewPlayAnotherPresentation=function(event){self.closeActionMenu(),event.stopPropagation();self.getPresentation().CreateStep("Presentation Step");event=self.getPresentation().CreateAction(self._defaultPlayAnotherPresentationAction);self._updateTreeAndOpenPropertyForId(event.ID)},self.createNewSetTime=function(event){self.createNewAction(self._defaultSetTimeAction),event.stopPropagation()},self.nextSibilingIdOf=function(actionId){var sibId="";try{sibId=self.getPresentation().GetItem(actionId).NextSibling.ID}catch(e){}return sibId},self.lastChildIdOf=function(stepId){var lastChildId="";try{for(var lastChild=self.getPresentation().GetItem(stepId).FirstChild;lastChild&&lastChild.NextSibling;)lastChild=lastChild.NextSibling;lastChildId=lastChild.ID}catch(e){}return lastChildId},self.createMovie=function(){self.getPresentation().CreateMovie(self.movieSettings.frameSize,self.movieSettings.framesPerSec,self.movieSettings.hideOverlay)},SGWorld.AttachEvent("OnProjectTreeAction",self.onProjectTreeAction),SGWorld.AttachEvent("OnPresentationEvent",self.onPresentationEvent),SGWorld.AttachEvent("OnKeyboard",self.onKeyboardEvent),self.dragDrop={dragPayloadId:void 0,allowDrop:!1,dragPayloadIsStep:!1,getActionIdFromDomElement:function(element){for(var actionId,p=element;p;){if("LI"==p.nodeName){actionId=p.id;break}p=p.parentElement}return actionId},getStepIdFromDomElement:function(element){for(var stepId,p=element;p;){if("LI"==p.nodeName)if(0==self.getPresentation().GetItem(p.id).Type){stepId=p.id;break}p=p.parentElement}return stepId},onStepDragStart:function(ev){if(0==self.isEditMode())return ev.preventDefault(),ev.stopPropagation(),!1;$(self.presentation.steps).each(function(index,_step){$("#stepActions__"+_step.id).css("opacity","0.3")}),self.dragDrop.dragPayloadIsStep=!0,ev.dataTransfer.allowedDropTypes="move";ev=self.dragDrop.getStepIdFromDomElement(ev.target);self.dragDrop.dragPayloadId=ev},onStepDragEnd:function(ev){$(self.presentation.steps).each(function(index,_step){$("#stepActions__"+_step.id).css("opacity","1.0"),$("#"+_step.id+"_drop_target").css("display","none")})},onDropStep:function(ev){if(0!=self.dragDrop.allowDrop&&(ev=self.dragDrop.getStepIdFromDomElement(ev.target))){var step=self.getPresentation().GetItem(ev);if(step&&step.Parent){var draggedItem=self.getPresentation().GetItem(self.dragDrop.dragPayloadId);if(draggedItem&&0==draggedItem.Type){draggedItem=step.Parent.ID;self.getPresentation().MoveItem(self.dragDrop.dragPayloadId,draggedItem,ev)}else{try{for(var lastChild=step.FirstChild;lastChild&&lastChild.NextSibling;)lastChild=lastChild.NextSibling;lastChild.ID}catch(e){}self.getPresentation().MoveItem(self.dragDrop.dragPayloadId,ev,lastChild?lastChild.ID:"")}self.updateTreeFromTe()}}self.dragDrop.dragPayloadId=void 0},onDragOverStep:function(ev){if(self.dragDrop.allowDrop=!1,self.dragDrop.dragPayloadId)if(1==self.dragDrop.dragPayloadIsStep){if((stepId=self.dragDrop.getStepIdFromDomElement(ev.target))&&stepId!=self.dragDrop.dragPayloadId){var step=self.getPresentation().GetItem(stepId);try{step.FirstChild}catch(e){}var draggedStepNextSibling=self.getPresentation().GetItem(self.dragDrop.dragPayloadId).NextSibling;0==(step&&draggedStepNextSibling&&step.ID==draggedStepNextSibling.ID)&&(self.dragDrop.allowDrop=!0,$("#"+stepId+"_drop_target").css("display","block"))}}else{var stepId=self.dragDrop.getStepIdFromDomElement(ev.target);self.dragDrop.allowDrop=!0,$("#step_div_"+stepId).addClass("dropHilight")}self.dragDrop.allowDrop?ev.dataTransfer.allowedDropTypes="move":(ev.dataTransfer.dropEffect="none",ev.dataTransfer.allowedDropTypes="none"),ev.preventDefault()},onDragLeaveStep:function(ev){ev=self.dragDrop.getStepIdFromDomElement(ev.target);ev&&($("#"+ev+"_drop_target").css("display","none"),$("#step_div_"+ev).removeClass("dropHilight"))},onDragEnterStep:function(ev){ev.preventDefault()},onActionDragStart:function(ev){if(0==self.isEditMode())return ev.preventDefault(),ev.stopPropagation(),!1;self.dragDrop.dragPayloadIsStep=!1,ev.dataTransfer.allowedDropTypes="move";var actionId=self.dragDrop.getActionIdFromDomElement(ev.target),actionId=(self.dragDrop.dragPayloadId=actionId,0==self.hasSelection(actionId)&&self.showSelected(actionId),self.getActionById(actionId));actionId&&actionId.actionType==PresentationAction.PlayAnotherPresentation&&(ev.dataTransfer.allowedDropTypes="none")},onDragOverAction:function(ev){var actionId,draggedItem,dropTargetItem;self.dragDrop.allowDrop=!1,0==self.dragDrop.dragPayloadIsStep&&self.dragDrop.dragPayloadId?(actionId=self.dragDrop.getActionIdFromDomElement(ev.target))&&actionId!=self.dragDrop.dragPayloadId&&(draggedItem=self.getActionById(self.dragDrop.dragPayloadId),dropTargetItem=self.getActionById(actionId),draggedItem&&draggedItem.actionType==PresentationAction.PlayAnotherPresentation||dropTargetItem&&dropTargetItem.actionType==PresentationAction.PlayAnotherPresentation?(ev.dataTransfer.dropEffect="none",ev.dataTransfer.allowedDropTypes="none"):(draggedItem=self.getPresentation().GetItem(actionId),dropTargetItem=self.getPresentation().GetItem(self.dragDrop.dragPayloadId).NextSibling,0==(draggedItem&&dropTargetItem&&draggedItem.ID==dropTargetItem.ID)&&(self.dragDrop.allowDrop=!0,$("#"+actionId+"_drop_target").css("display","block")))):self.dragDrop.onDragOverStep(ev),ev.preventDefault()},onDropAction:function(ev){if(1==self.dragDrop.dragPayloadIsStep)self.dragDrop.onDropStep(ev);else{if(0!=self.dragDrop.allowDrop){var targetId=self.dragDrop.getActionIdFromDomElement(ev.target),reselectItems=[];for($(".selected_").each(function(index){try{var item,target,stepId,itemId=this.id;itemId&&(item=self.getPresentation().GetItem(itemId),target=self.getPresentation().GetItem(targetId))&&item&&item.Parent&&1==item.Type&&(stepId=target.Parent.ID,self.getPresentation().MoveItem(itemId,stepId,targetId),reselectItems.push(itemId))}catch(e){}}),self.updateTreeFromTe(),self.clearSelection();0<reselectItems.length;)self.addToSelection(reselectItems.pop())}self.dragDrop.dragPayloadId=void 0}},onDragLeaveAction:function(ev){var actionId;0==self.dragDrop.dragPayloadIsStep?(actionId=self.dragDrop.getActionIdFromDomElement(ev.target))&&$("#"+actionId+"_drop_target").css("display","none"):self.dragDrop.onDragLeaveStep(ev)},onDragEnterAction:function(ev){ev.preventDefault()}},self}function Form(fieldsetId){var self={get currentData(){return $("#properties")[0].jsonData},get currentSchema(){return $("#properties")[0].schema},showingSettings:!1,propertiesPageHeight:0,creatingRecordAction:!0,lastKnownSelectedItemId:void 0};return self.fieldsetId=fieldsetId,self.onClose=function(){},self.close=function(){self.onClose()},$("#closeProperties").click(self.close),self.excludedPropertis=["id","splineSpeedFunction","splineTurnSpeedFunction","isFlyTo","poi","LastKnownCaption","TeObjectId","pathToGroup"],self.getDescriptionFor=function(jsonData){if(null!=jsonData)return presentationCommon.getDescriptionFor(jsonData)},self.flatenJsonData=function(data){var flattenedData=$.extend(!0,{},data);if(flattenedData.options){for(var opt in flattenedData.options)flattenedData[opt]=flattenedData.options[opt];flattenedData.options=void 0}return flattenedData},self.flatenJsonSchema=function(schema){var flattenedSchema=$.extend(!0,{},schema);if(flattenedSchema.properties.options&&flattenedSchema.properties.options.properties){for(var prop in flattenedSchema.properties.options.properties)flattenedSchema.properties[prop]=flattenedSchema.properties.options.properties[prop];flattenedSchema.properties.options=void 0}return flattenedSchema},self.addEditMessageButton=function(teMessageObjectId){teMessageObjectId=$("<div class='fieldLine' id='setCurrentLocation' class='s7 colValue' style='                                                        border: none;                                                        display: flex;                                                        justify-content: center;                                                        align-items: center;                                                        background: #1EB0DF 0% 0% no-repeat padding-box;                                                        border-radius: 4px;                                                        opacity: 1;                                                        width: 100%;                                                        height: 51px;                                                        cursor: pointer;'                                                        onclick='_form.editMessageInTe(\""+teMessageObjectId+"\")'>                                    <span id='_setCurrentSpan' style='color: white; padding: 0px 10px; line-height: 18px;'>"+SGLang.i18n("editMessageObjectInTe")+"</span>                                </div>");$("#"+self.fieldsetId).append(teMessageObjectId),self.propertiesPageHeight+=60},self.openSettings=function(createMovieSettings){var settingsSchema,name;for(name in self.clearForm(),presentationSchema.definitions){var def=presentationSchema.definitions[name];if(def&&def.properties)if(createMovieSettings){if(def.properties.movieSettings){settingsSchema=def.properties.movieSettings;break}}else if(def.properties.settings){settingsSchema=def.properties.settings;break}}if(null==settingsSchema)return!1;$("#properties")[0].jsonData=void 0;var prop,divCreateMovie,divCreateMovieParent,originalData=JSON.parse(presentationEditor.getPresentation().SettingsJSON);for(prop in presentationEditor.presentation.settings=originalData,settingsSchema.properties)null==presentationEditor.presentation.settings[prop]&&(presentationEditor.presentation.settings[prop]=originalData[prop]),self.addActionEntry(prop,originalData[prop],settingsSchema,function(name,newValue){createMovieSettings?("frameSize"==name&&(newValue=settingsSchema.properties.frameSize.oneOf.indexOf(newValue)),presentationEditor.movieSettings[name]=newValue):presentationEditor.presentation.settings[name]=newValue;try{presentationEditor.getPresentation().SettingsJSON=JSON.stringify(presentationEditor.presentation.settings)}catch(e){presentationEditor.presentation.settings=originalData}});return createMovieSettings&&(divCreateMovie=$("<div id='createMovie' class='s7 colValue' style='                                                            border: 1px solid #1EB0DF;                                                            display: flex;                                                            justify-content: center;                                                            align-items: center;                                                            border-radius: 4px;                                                            background: #FAFAFA 0% 0% no-repeat padding-box;                                                            opacity: 1;                                                            width: 100%;                                                            height: 31px;                                                            cursor: pointer;'                                                            onclick='presentationEditor.createMovie()'>                                        <span id='_createMovieSpan' style='color: #1EB0DF;'>"+SGLang.i18n("CreateMovie")+"</span>                                    </div>"),divCreateMovieParent=$("<div class='fieldLine' style='margin-top: 40px;'></div>"),$("#"+self.fieldsetId).append(divCreateMovieParent),divCreateMovieParent.append(divCreateMovie)),self.updatePropertiesCaption(),self.propertiesPageHeight=-1,self.showingSettings=!0},self.setProperties=function(jsonData,schema,clearForm){if(0!=clearForm&&self.clearForm(),1<presentationEditor.getSelectedEntriesIds().length)return!1;var objectSchema,name,jsonDataIsStep=!1;for(name in schema.definitions){var def=schema.definitions[name];if(def.properties&&def.properties.actionType&&def.properties.actionType.enum[0]==jsonData.actionType){objectSchema=def;break}if("PresentationStep"==name&&null!=jsonData.Type&&0==jsonData.Type){objectSchema=def,jsonDataIsStep=!0;break}}if(null==objectSchema)return!1;self.propertiesPageHeight=90,$("#properties")[0].jsonData=jsonData,$("#properties")[0].schema=objectSchema;var flattenedData=self.flatenJsonData(jsonData),flattenedSchema=self.flatenJsonSchema(objectSchema);if(jsonData.actionType==PresentationAction.SetTime)self.addDateEntry(flattenedData,flattenedSchema,function(name,newValue){jsonData.options[name]=newValue,self.pushActionToTerraExplorer(),self.updatePropertiesCaption()});else{for(var prop in flattenedSchema.properties){if(flattenedSchema.properties.actionType){if("Caption"==flattenedSchema.properties.actionType.enum[0]){if(-2==flattenedData.timeOutInterval)return!1;-1==flattenedData.timeOutInterval&&(flattenedData.timeOutInterval=void 0)}if("PlayRoute"==flattenedSchema.properties.actionType.enum[0])return}else"description"==prop&&(flattenedData[prop]=$("#step_"+jsonData.ID)[0].textContent),"RequireClick"==prop&&(flattenedData[prop]=1==SGWorld.SetParamEx(9954,jsonData.ID,999));0!=jsonDataIsStep||"actionType"!=prop&&"description"!=prop?("options"!=prop&&(self.updatePropertiesCaption(),self.addActionEntry(prop,flattenedData[prop],flattenedSchema,function(name,newValue){var stepJson;jsonDataIsStep?("description"==name&&((stepJson=JSON.parse(jsonData.ItemJSON)).description=newValue,jsonData.ItemJSON=JSON.stringify(stepJson),$("#step_"+stepJson.id)[0].textContent=newValue),"RequireClick"==name&&SGWorld.SetParamEx(9954,jsonData.ID,newValue?1:0)):(jsonData.options[name]=newValue,self.pushActionToTerraExplorer()),self.updatePropertiesCaption()})),setTimeout(function(){jscolor.bind()},200)):self.updatePropertiesCaption()}(flattenedSchema.properties.TeObjectId||flattenedSchema.properties.pathToGroup)&&("Message"==flattenedSchema.properties.actionType.enum[0]?self.addEditMessageButton(jsonData.options.TeObjectId):self.addDropAreaEntry(flattenedSchema))}var firstProperty=$("#"+self.fieldsetId).find("input")[0];return firstProperty&&setTimeout(function(){firstProperty.focus(),firstProperty.select()},100),!0},self.updatePropertiesCaption=function(){var d=self.getDescriptionFor(self.currentData);$("#propertiesCaption")[0].textContent=null!=self.currentData?d[0]+" "+SGLang.i18n("Properties")+":":SGLang.i18n("Settings")},self.clearForm=function(){for(var actionProperties=document.getElementById(self.fieldsetId);actionProperties.firstChild;)actionProperties.removeChild(actionProperties.lastChild)},self.refresh=function(){presentationEditor.updateActionEntryDescription(),presentationEditor.onActionClicked()},self.pushActionToTerraExplorer=function(){if(null!=self.currentData){var current=presentationEditor.getPresentation().GetItem(self.currentData.id),originalData=current.ItemJSON;try{current.ItemJSON=JSON.stringify(self.currentData)}catch(e){current.ItemJSON=originalData}presentationEditor.updateActionEntryDescription(self.currentData.id),self.updateDropAreaEntry()}},self.dropProjectTreeItemOnAction=function(){if(null==self.currentData)self.dragDrop.dragPayloadId=void 0;else{if(self.currentData.options.poi=void 0,self.currentData.options.pathToGroup=void 0,SGWorld.ProjectTree.IsGroup(self.dragDrop.dragPayloadId)){for(var groupName=SGWorld.ProjectTree.GetItemName(self.dragDrop.dragPayloadId),parentId=SGWorld.ProjectTree.GetNextItem(self.dragDrop.dragPayloadId,ItemCode.PARENT);""!=parentId;)groupName=SGWorld.ProjectTree.GetItemName(parentId)+"\\"+groupName,parentId=SGWorld.ProjectTree.GetNextItem(parentId,ItemCode.PARENT);self.currentData.options.pathToGroup=groupName,self.currentData.options.TeObjectId=void 0}else self.currentData.options.TeObjectId=self.dragDrop.dragPayloadId,self.currentData.options.pathToGroup=void 0;self.dragDrop.dragPayloadId=void 0,self.pushActionToTerraExplorer(),self.updatePropertiesCaption()}},self.setCurrentViewerLocationAsActionLocation=function(){var location,isRelative,pos;null!=self.currentData&&(location=SGWorld.Creator.CreateLocationHere(SGWorld.ProjectTree.HiddenGroupID),pos=(isRelative=self.currentData.options.poi&&self.currentData.options.poi.isRelative)?location.Position.ToRelative():location.Position.ToAbsolute(),self.currentData.options.poi={x:pos.X,y:pos.Y,altitude:pos.Altitude,viewerYaw:360-pos.Yaw,viewerPitch:pos.Pitch,distance:pos.Distance,isRelative:isRelative},SGWorld.Creator.DeleteObject(location.ID),self.currentData.options.TeObjectId=void 0,self.currentData.options.pathToGroup=void 0,self.pushActionToTerraExplorer(),self.updatePropertiesCaption(),$("#setCurrentLocation").addClass("dropArea-animation-accepted"),setTimeout(function(){$("#setCurrentLocation").removeClass("dropArea-animation-accepted")},2e3))},self.updateDropAreaEntry=function(){var currentVal=self.getDescriptionFor(self.currentData);$("#"+self.currentData.id+"_current").html("<b>"+SGLang.i18n("CurrentValue")+"</b>"+currentVal[1])},self.editMessageInTe=function(messageObjId){var currentData=self.currentData,messageObjId=SGWorld.Creator.CreateTreeHotlink(messageObjId,SGWorld.ProjectTree.HiddenGroupID);SGWorld.ProjectTree.EditItem(messageObjId.ID),SGWorld.Creator.DeleteObject(messageObjId.ID),SGWorld.ProjectTree.SelectItem(presentationEditor.presentation.id),presentationEditor.onEditItem(currentData.id)},self.addRecordEntry=function(){var div0=$("<div>",{class:"fieldLine"}),div1=(div0.css({width:"100%",height:"20px"}),$("<div>")),div0=(div1.css({width:"100%",height:"100%"}),div0.append(div1),$("#"+self.fieldsetId).append(div0),$("<div id='btnToggleRecord' style='height: 64px; width:64px; border-radius: 6px; border: 1px solid #a0a0a0; ' onclick='presentationEditor.toggleRecord()'>                                    <img id='btnImgToggleRecord' width='64px' height='64px' src='images/startRecord.png' class='link2' >                                </div>"));div1.append(div0),self.propertiesPageHeight+=90},self.addDeleteEntry=function(){var divDelete=$("<div class='fieldLine' style='height: 116px;'></div>");$("#"+self.fieldsetId).append(divDelete),divDelete.append($("<div class='colName'></div>                                <div id='deleteItem' class='s7 colValue' style='                                                    border: 1px solid red;                                                    display: flex;                                                    justify-content: center;                                                    align-items: center;                                                    border-radius: 4px;                                                    opacity: 1;                                                    width: 100%;                                                    height: 31px;                                                    cursor: pointer;'                                                    onclick='presentationEditor.onDeleteItem(\""+self.currentData.id+"\")'>                                    <span id='_setCurrentSpan' style='color: red;'>"+SGLang.i18n("deleteItem")+"</span>                                </div>                            </div>")),$("#"+self.fieldsetId).append(divDelete),self.propertiesPageHeight+=80},self.addDropAreaEntry=function(flattenedSchema){var currentVal=self.getDescriptionFor(self.currentData),_name=(currentVal[1]&&((s={})[_name=replaceAll(currentVal[0]," ","")]={title:currentVal[0],type:"string",readOnly:!0},s={properties:s},currentVal="["==currentVal[1][0]?currentVal[1].slice(1,-1):currentVal[1],self.addActionEntry(_name,currentVal,s).css("pointer-events","none")),""),currentVal=void 0,s=(flattenedSchema.properties.TeObjectId&&flattenedSchema.properties.pathToGroup?(_name=SGLang.i18n("dropGroupOrObject"),currentVal=self.dragDrop.allowedDropTypes.ObjectsOrGroups):flattenedSchema.properties.TeObjectId?(_name=SGLang.i18n("dropLocationObject"),currentVal=self.dragDrop.allowedDropTypes.locationsOrObjects,"DynamicObject"==self.currentData.actionType?_name=SGLang.i18n("dropDynamicObject"):"PlayAnotherPresentation"==self.currentData.actionType&&(_name=SGLang.i18n("dropPresentationObject"),currentVal=self.dragDrop.allowedDropTypes.presentationObject)):(_name=SGLang.i18n("dropGroup"),currentVal=self.dragDrop.allowedDropTypes.groups),$("<div class='fieldLine' style='height: 116px;'></div>")),flattenedSchema=($("#"+self.fieldsetId).append(s),$("<div  id='dropArea' class='colValue dropArea' style='background: #FAFAFA 0% 0% no-repeat padding-box; border: 2px dashed #CBCBCB; border-radius: 4px; opacity: 1;display: flex; justify-content: center; align-items: center;'><img id='_dropImage' style='padding: 10px;' src='images/dropAreaPlus.png'><span id='_dropSpan' style='width: 100%; font-size: 12pt; display: inline-grid; color: black; padding-right: 16px;'>"+_name+"</span></div>"));s.append(flattenedSchema),(flattenedSchema[0].allowedDropTypes=currentVal)==self.dragDrop.allowedDropTypes.locationsOrObjects&&"FlyTo"==self.currentData.actionType?(_name=$("<div id='setCurrentLocation' class='s7 colValue' style='                                                        border: 1px solid #1EB0DF;                                                        display: flex;                                                        justify-content: center;                                                        align-items: center;                                                        background: #FAFAFA 0% 0% no-repeat padding-box;                                                        border-radius: 4px;                                                        opacity: 1;                                                        width: 100%;                                                        height: 31px;                                                        cursor: pointer;'                                                        onclick='_form.setCurrentViewerLocationAsActionLocation(\""+self.currentData.id+"\")'>                                    <span id='_setCurrentSpan' style='color: #1EB0DF;'>"+SGLang.i18n("UseCurrentPosition")+"</span>                                </div>"),s=$("<div class='fieldLine'></div>"),$("#"+self.fieldsetId).append(s),s.append(_name)):(flattenedSchema.css("width","100%"),flattenedSchema.css("margin-right","0px")),self.propertiesPageHeight+=170},self.addDateEntry=function(flattenedData,flattenedSchema,callback){new Date(flattenedData.year,flattenedData.month,flattenedData.day,flattenedData.hour,flattenedData.minute,flattenedData.second);var flattenedData=$("<div>",{}),flattenedSchema=$("<div>",{text:flattenedSchema.title+":"}),dateInfo=(flattenedData.append(flattenedSchema),$("#"+self.fieldsetId).append(flattenedData),self.propertiesPageHeight+=240,{}),flattenedSchema=$("<div id='flatcal' style='display:flex; justify-content:space-around;'></div>");function getDateText(date,d){dateInfo[date.print("%Y%m%d")];return d}function flatCallback(cal){cal.dateClicked&&(callback("year",cal.date.getFullYear()),callback("month",cal.date.getMonth()),callback("day",cal.date.getDate()),callback("hour",cal.date.getHours()),callback("minute",cal.date.getMinutes()),callback("second",cal.date.getSeconds()),window.status="Selected: "+cal.date,cal=dateInfo[cal.date.print("%Y%m%d")])&&(window.status+=".  Additional info: "+cal)}return flattenedData.append(flattenedSchema),$("#"+self.fieldsetId).append(flattenedData),setTimeout(function(){Calendar.setup({flat:"flatcal",dateText:getDateText,flatCallback:flatCallback,weekNumbers:!1,isPopup:!1,showsTime:!0})},200),flattenedData},self.addActionEntry=function(name,value,flattenedSchema,callback){if(!(0<=self.excludedPropertis.indexOf(name))){var sel,type=flattenedSchema.properties[name].type,title=flattenedSchema.properties[name].title,def_val=flattenedSchema.properties[name].default?flattenedSchema.properties[name].default+" (default)":"",title=title||name;if("string"==type){var oneof=flattenedSchema.properties[name].oneOf;if(oneof){var entry,strSelector="<select  class='colValue' style='color: #5a5d60;'>";for(entry in oneof)strSelector+="<option "+(value==oneof[entry]?"selected":"")+" value='"+oneof[entry]+"'>"+oneof[entry]+"</>";strSelector+="</select >",sel=$(strSelector)}else type="text"}else if("boolean"==type){if("RTL"==name)return;sel=$("<select class='colValue' style=''><option "+(value?"":"selected")+" value='false'>False</option><option "+(value?"selected":"")+" value='true'>True</option></select>")}else{if("integer"!=type&&"number"!=type&&"range"!=type)return;type="number"}var div0=$('<div class="fieldLine">'),divLabel=$('<div class="colName" style="">'+title+":</div>"),divInput=$('<div class="colValue" style="">');if(div0.append(divLabel),$("#"+self.fieldsetId).append(div0),sel)sel.css("width","100%"),sel.css("height","100%"),divInput.append(sel),input=sel;else{var input=$("<input>",{type:type,value:value,placeholder:def_val,id:"input_"+name}),isColor=-1!==title.toLowerCase().indexOf("color".toLowerCase());if(isColor){divLabel=SGWorld.Creator.CreateColor();try{divLabel.FromRGBColor(value),value=divLabel.ToHTMLColor().substring(1)}catch(e){value=0}(input=$('<input  class="col">',{class:"color { onImmediateChange: 'this.presentationCallback('"+name+"',$(this).val())',                                pickerFaceColor: 'white',                                pickerFace: 3,                                pickerBorder: 1,                                pickerInsetColor: '#A0A0A0',                                pickerClosable: true,                                pickerBorderColor: '#A0A0A0',                                }",value:value})).css("width","100%")}else input.css("width","100%");divInput.append(input)}return div0.append(divInput),input[0].presentationCallback=callback,input.on("change focusout",function(e){if(callback){var newVal=$(this).val();if(isColor){var c=SGWorld.Creator.CreateColor();c.fromHTMLColor(newVal),newVal=c.ToARGBColor()}else switch(flattenedSchema.properties[name].readOnly&&(newVal=value),flattenedSchema.properties[name].type){case"boolean":newVal="true"==newVal;break;case"integer":newVal=parseInt(newVal);break;case"number":case"nrange":newVal=parseFloat(newVal)}callback(name,newVal)}}),self.propertiesPageHeight+=30,div0}},self.dragDrop={dragName:void 0,allowDrop:void 0,dragPayloadId:void 0,dragPayloadType:void 0,allowedDropTypes:{groups:2,locations:4,objects:8,ObjectsOrGroups:10,locationsOrObjects:12,locationsOrObjectsOrGroups:14,presentationObject:16},setEnabled:function(bEnabled){bEnabled?setTimeout(function(){$("#_dropImage").attr("src","images/dropAreaPlus.png")},1e3):($("#_dropImage").attr("src","images/dropAreaX.png"),$("#_dropSpan").css("opacity",.3))},onDragOver:function(ev){var jqDropArea=$("#dropArea");"dropArea"==ev.target.id||jqDropArea[0].contains(ev.target)?(ev.preventDefault(),self.dragDrop.allowDrop?(jqDropArea.addClass("dropArea-animation-accepted"),ev.dataTransfer.dropEffect="link",self.dragDrop.setEnabled(!0)):(ev.dataTransfer.dropEffect="none",self.dragDrop.setEnabled(!1))):(jqDropArea.removeClass("dropArea-animation-accepted"),ev.dataTransfer.dropEffect="none",self.dragDrop.setEnabled(!0))},onDrop:function(ev){var jqDropArea=$("#dropArea");ev.preventDefault(),jqDropArea.removeClass("dropArea-animation-accepted"),self.dragDrop.setEnabled(!0),0==self.dragDrop.allowDrop?self.dragDrop.dragPayloadId=void 0:self.dropProjectTreeItemOnAction()},onDragLeave:function(ev){$("#dropArea").removeClass("dropArea-animation-accepted"),self.dragDrop.setEnabled(!0),self.dragDrop.dragPayloadType=void 0},onDragEnter:function(ev){var obj,jqDropArea=$("#dropArea");try{self.dragDrop.dragPayloadType=void 0,self.lastKnownSelectedItemId&&(self.dragDrop.dragPayloadId=self.lastKnownSelectedItemId,SGWorld.ProjectTree.IsGroup(self.dragDrop.dragPayloadId)?self.dragDrop.dragPayloadType=self.dragDrop.allowedDropTypes.groups:(obj=SGWorld.Creator.GetObject(self.dragDrop.dragPayloadId)).ObjectType==ObjectTypeCode.OT_LOCATION?self.dragDrop.dragPayloadType=self.dragDrop.allowedDropTypes.locations:obj.ObjectType==ObjectTypeCode.OT_PRESENTATION?self.dragDrop.dragPayloadType=self.dragDrop.allowedDropTypes.presentationObject:obj.Position&&(self.dragDrop.dragPayloadType=self.dragDrop.allowedDropTypes.objects),self.dragDrop.allowDrop=jqDropArea[0].allowedDropTypes&self.dragDrop.dragPayloadType)}catch(e){self.dragDrop.allowDrop=!1}}},self}